# Proposal: persona-gen-slice

## Motivation
現行のPython版ツール（v1.x）では、話者の種族や声の種類から一律に口調を推定しているため、NPC個別の性格や背景設定が反映されず、翻訳時の口調に一貫性が欠ける課題がありました。
また、翻訳精度向上の文脈として各NPCの過去の会話データをそのままLLMへ渡すアプローチは、LLMのコンテキスト長（トークン上限）を超過してしまうリスクがあります。
AIによる高品質な文脈理解を実現するためには、会話データから特徴を抽出・要約した「NPCペルソナ」を事前生成し、トークン利用量を節約しつつ一貫した翻訳を可能にする仕組みが必要です。
さらに、新アーキテクチャ（v2.0）の「Vertical Slice Architecture」および「Consumer-Driven Contracts DTO Style」に準拠した独立したスライスとして実装し、全体の保守性を向上させます。

## Capabilities

### New Capabilities
- `PersonaGenSlice`: 以下の責務を持つ独立したスライス。
  - **会話データの収集・スコアリング**: ロード済みのデータから、NPCごとに最大100件の会話データを収集。上限を超える場合は、固有名詞や感情表現に基づく独自スコアリングにより重要な会話を選別する。
  - **トークン利用量の事前計算**: 収集したデータの推定トークン量を計算し、LLMのコンテキスト制限超過を防止する。
  - **LLMペルソナ生成**: 収集した会話とNPC属性を利用して、LLMに「性格特性」「話し方の癖」「背景設定」を要約したペルソナテキストを生成させる。
  - **永続化と独立性**: 生成したペルソナをSQLiteDB（`npc_personas`テーブル）へ保存する。本スライスは独自の入力DTO（`PersonaGenInput`）を定義し、他スライスのデータ構造に依存しない完全な自己完結性を持つ。

### Modified Capabilities

## Impact
- **アーキテクチャ**: 新規パッケージ `pkg/persona_gen` が追加されます。完全な Vertical Slice として実装され、外部の DTO には依存しません（連携は Process Manager などのオーケストレーター層でマッピングされます）。
- **データベース**: SQLite にペルソナ情報を格納するための新しいテーブル `npc_personas` が定義・作成されます（テーブル作成等もスライス内にカプセル化されます）。
- **後続処理 (Pass 2)**: 翻訳エンジン（Term Translator または Context Engine 等）がシステムプロンプトを構築する際、この `npc_personas` テーブルを参照して話者プロファイルを追加することが可能になります。
