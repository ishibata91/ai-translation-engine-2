<artifact id="specs" change="term-translator-slice" schema="spec-driven">

## 追加される要件 (ADDED Requirements)

### 要件: ExtractedData からの用語翻訳
システムは、`ExtractedData` に含まれる用語レコード（NPC、アイテム、魔法、ロケーション等）を LLM を用いて翻訳し、Mod 専用の SQLite データベースに保存しなければならない (SHALL)。

#### シナリオ: 未翻訳の名詞レコードの翻訳
- **WHEN** 用語翻訳用に設定された、有効な未翻訳の名詞レコードが `ExtractedData` に含まれている場合
- **THEN** システムは LLM 用の翻訳リクエストを生成し、翻訳を実行し、個々の結果を Mod 用語 DB に保存する

### 要件: NPC 名のペア翻訳
システムは、同一の EditorID を持つ `NPC_:FULL` と `NPC_:SHRT` を、文脈の一貫性を担保するためにペアの翻訳リクエストとして処理しなければならない (MUST)。

#### シナリオ: FULL 名と SHRT 名を持つ NPC の翻訳
- **WHEN** 同一の EditorID に紐づく `NPC_:FULL` と `NPC_:SHRT` が入力に含まれている場合
- **THEN** システムはそれらを単一の `TermTranslationRequest` にペアリングし、LLM プロンプト内で同時に評価させ、結果を 2 つの個別レコードとして DB に保存する

### 要件: 参照用語検索（ステミングおよび部分一致）
システムは、Dictionary Builder Slice によって構築された既存の用語辞書から文脈用語を検索しなければならない (SHALL)。その際、完全一致、ステミング、および貪欲部分一致を適用し、LLM プロンプトに `reference_terms` として含める。

#### シナリオ: ステミングによる複数形・所有格アイテム名の照合
- **WHEN** 原文が複数形や所有格（例: "Daedric Swords", "Auriel's"）であり、辞書にその語幹（ステム）形式が含まれている場合
- **THEN** システムは Snowball ステミングを適用し、辞書内の語幹完全一致を見つけ、それを参照用語として含める

#### シナリオ: 参照用語の貪欲最長部分一致
- **WHEN** 原文に対して辞書内で複数の重複する部分一致候補が見つかった場合
- **THEN** システムは貪欲最長一致アルゴリズムを適用して、短い重複候補を除外し、最長の独立した一致のみを提供する

#### シナリオ: NPC 苗字の部分一致照合
- **WHEN** 入力が名詞（例: "Battle-Born"）であり、辞書にフルネームの NPC（例: "Jon Battle-Born"）が含まれている場合
- **THEN** システムは `npc_terms_fts` テーブルに対して FTS5 MATCH を使用して部分一致を見つけ、それを参照用語として含める

### 要件: 強制翻訳の実行
システムは、原文が参照辞書の原文と完全一致する場合、LLM の呼び出しをスキップして辞書の訳をそのまま採用しなければならない (SHALL)。

#### シナリオ: 完全一致による翻訳オーバーライド
- **WHEN** 原文が辞書 DB 内のエントリの英語原文と完全に一致する場合
- **THEN** システムは LLM API を呼び出すことなく、キャッシュされた辞書用語を使用して翻訳を完了し、`Status="cached"` として保存する

### 要件: 設定によるレコードタイプのフィルタリング
システムは、`TermRecordConfig` で定義された対象外のレコード、または既に翻訳済みのレコードをフィルタリングしてスキップしなければならない (SHALL)。

#### シナリオ: 除外された、または翻訳済みのレコードタイプのフィルタリング
- **WHEN** `ExtractedData` に `TermRecordConfig` によって除外されたレコードが含まれている場合
- **THEN** システムはそのレコードの翻訳リクエスト生成をスキップし、LLM を呼び出さない

### 要件: 既存の Mod 用語に対する UPSERT 更新
システムは、同一の `original_en` と `record_type` が再度処理された場合、Mod 用語 DB 内の既存の翻訳を更新しなければならない (SHALL)。

#### シナリオ: 既存の用語の再翻訳
- **WHEN** `(original_en, record_type)` の組み合わせが既に Mod 用語 DB に存在する場合
- **THEN** システムは UPSERT を実行し、重複を作成せずに `translated_ja` とメタデータを更新する

### 要件: LLM 部分失敗時の耐性
システムは、並列バッチ翻訳において一部の LLM リクエストが失敗しても、プロセス全体を中断してはならない (SHALL)。

#### シナリオ: 一部の用語の翻訳失敗
- **WHEN** 並列バッチ内の一部の用語に対して LLM がエラーを返した場合
- **THEN** システムはエラーを記録し、正常に翻訳された用語のみを DB に保存し、パニックを起こさずにプロセスを完了する

</artifact>

