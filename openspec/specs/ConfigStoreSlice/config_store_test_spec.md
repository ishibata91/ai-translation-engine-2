# 設定・レイアウト保存インフラ テスト設計 (Config Store Test Spec)

## 1. テスト方針
ConfigStoreはアプリケーション全体の基盤であるため、インメモリSQLite (`:memory:`) を用いた高速な単体テストを中心に検証する。

1. **単体テスト (Unit Test)**: インメモリSQLiteを使用し、CRUD操作・型変換・変更通知・マイグレーションを検証する。
2. **統合テスト (Integration Test)**: 実ファイルベースのSQLiteを使用し、永続化・再起動後の復元を検証する。

## 2. テストケース

### 2.1 ConfigStore CRUD（バックエンド設定・プレーン文字列）
| ID | カテゴリ | ケース内容 | 期待結果 |
| :--- | :--- | :--- | :--- |
| CS-01 | 正常系 | Set → Get で値を保存・取得 | 保存した値が正しく取得できる |
| CS-02 | 正常系 | 同一キーにSetを2回実行 | 後の値で上書きされる |
| CS-03 | 正常系 | Delete で既存キーを削除 | 削除後のGetでエラー（未設定）が返る |
| CS-04 | 正常系 | GetAll で名前空間内の全キーを取得 | 該当名前空間の全エントリが返る |
| CS-05 | 異常系 | 存在しないキーをGet | デフォルト値またはエラーが返る |
| CS-06 | 境界値 | 空文字列のnamespace/key | バリデーションエラーが返る |
| CS-07 | 異常系 | JSON文字列をSetで格納しようとする | バリデーションエラーが返る（JSON不許可） |

### 2.2 UIStateStore CRUD（UIステート・JSON許可）
| ID | カテゴリ | ケース内容 | 期待結果 |
| :--- | :--- | :--- | :--- |
| US-01 | 正常系 | SetJSON → GetJSON で構造体を保存・復元 | JSON経由で構造体が正しくラウンドトリップする |
| US-02 | 正常系 | 配列値 `[300,500,200]` の保存・取得 | JSON配列が正しく保存・復元される |
| US-03 | 正常系 | Delete で既存キーを削除 | 削除後のGetでエラーが返る |
| US-04 | 正常系 | GetAll で名前空間内の全キーを取得 | 該当名前空間の全エントリが返る |
| US-05 | 異常系 | GetJSON に不正なJSON値が格納されている | エラーが返る（パニックしない） |

### 2.3 SecretStore
| ID | カテゴリ | ケース内容 | 期待結果 |
| :--- | :--- | :--- | :--- |
| SS-01 | 正常系 | APIキーの保存・取得 | secretsテーブルから正しく取得できる |
| SS-02 | 正常系 | APIキーの削除 | 削除後は取得できない |
| SS-03 | 正常系 | ListSecretKeys で名前空間内のキー一覧取得 | キー名のリストが返る（値は含まない） |

### 2.4 TypedAccessor（ConfigStore専用）
| ID | カテゴリ | ケース内容 | 期待結果 |
| :--- | :--- | :--- | :--- |
| TA-01 | 正常系 | GetString でデフォルト値付き取得 | 未設定時にデフォルト値が返る |
| TA-02 | 正常系 | GetInt / GetFloat / GetBool の型変換 | プレーン文字列から正しく型変換される |
| TA-03 | 異常系 | GetInt に非数値の文字列が格納されている | デフォルト値が返る（パニックしない） |

### 2.5 変更通知 (Watch)
| ID | カテゴリ | ケース内容 | 期待結果 |
| :--- | :--- | :--- | :--- |
| WA-01 | 正常系 | Watchを登録後にSetを実行 | ChangeEventがコールバックに通知される |
| WA-02 | 正常系 | Unsubscribe後にSetを実行 | コールバックが呼ばれない |
| WA-03 | 正常系 | 異なる名前空間のSetを実行 | 監視対象外のため通知されない |

### 2.6 マイグレーション
| ID | カテゴリ | ケース内容 | 期待結果 |
| :--- | :--- | :--- | :--- |
| MG-01 | 正常系 | 空のDBに対してMigrateを実行 | config, ui_state, secrets全テーブルが作成され、schema_versionが記録される |
| MG-02 | 正常系 | 既にv1のDBに対してv2マイグレーション | 差分のみ適用され、既存データは保持される |
| MG-03 | 正常系 | 最新バージョンのDBに対してMigrate | 何も変更されない |

## 3. スレッドセーフティ
- 複数Goroutineから同時にSet/Getを実行し、データ競合やデッドロックが発生しないことを `go test -race` で検証する。
