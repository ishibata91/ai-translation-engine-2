# LLMクライアント テスト設計 (LLM Client Test Spec)

## 1. テスト方針
LLMクライアントは外部APIに依存するため、以下の3つのレベルでテストを実施する。

1.  **単体テスト (Unit Test)**: Mockサーバーを使用して、リクエスト/レスポンスの変換ロジック、エラーハンドリング（タイムアウト、429 Too Many Requests等）を検証する。
2.  **統合テスト (Integration Test)**: 実際のAPI（またはテスト用エンドポイント）を使用して、接続性と認証を検証する。
3.  **契約テスト (Contract Test)**: 各プロバイダーが`LLMClient`インターフェースの振る舞い（期待されるエラー型、空のレスポンスの扱い等）を正しく満たしているかを検証する。

## 2. テストケース

### 2.1 LLMClient.Complete
| ID | カテゴリ | ケース内容 | 期待結果 |
| :--- | :--- | :--- | :--- |
| UT-01 | 正常系 | 正当なリクエストを送信 | `Success=true` と生成テキストが返る |
| UT-02 | 正常系 | Structured Output (JSON) を要求 | 有効なJSON文字列が返り、スキーマに適合する |
| UT-03 | 異常系 | タイムアウトが発生 | 適切なタイムアウトエラーが返る |
| UT-04 | 異常系 | APIキーが不正 | 認証エラー (401相当) が返る |
| UT-05 | 異常系 | レートリミット到達 | 再試行が必要であることを示すエラー (429相当) が返る |

### 2.2 BatchClient
| ID | カテゴリ | ケース内容 | 期待結果 |
| :--- | :--- | :--- | :--- |
| BT-01 | 正常系 | 複数リクエストのバッチ投入 | `BatchJobID` が返り、状態が `pending` になる |
| BT-02 | 正常系 | 完了したジョブの結果取得 | 全てのリクエストに対する `Response` 配列が取得できる |
| BT-03 | 異常系 | 存在しないジョブIDの照会 | エラー（Not Found相当）が返る |

### 2.3 共通・モック
- `MockProvider`: `LLMClient`を実装し、事前に設定したレスポンスを返すテスト用クラス。上位層（Context Engine等）のテストで使用する。

## 3. 異常系・エッジケースの扱い
- **空のプロンプト**: プロバイダー側でバリデーションを行い、エラーを返す。
- **最大トークン数超過**: モデルが途中で切った場合のフラグ（Finish Reason）を捕捉できるようにする。
- **ネットワーク断**: 指数バックオフによる再試行（Retry Policy）の検証。
