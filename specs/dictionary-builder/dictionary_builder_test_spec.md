# 辞書DB作成 テスト設計 (DictionaryBuilderSlice Test Spec)

本設計は `refactoring_strategy.md` セクション 6（テスト戦略）および セクション 7（構造化ログ基盤）に厳密に準拠し、個別関数の細粒度なユニットテストを作成せず、Vertical Slice の Contract に対する網羅的なパラメタライズドテスト（Table-Driven Test）を定義する。

## 1. テスト方針

1. **細粒度ユニットテストの排除**: 内部処理(`DictionaryImporter` や `DictionaryStore` 単体等)の細粒度なユニットテストは作成しない。
2. **網羅的パラメタライズドテスト**: すべてのテストを Table-Driven Test として実装し、インメモリ SQLite (`:memory:`) を用いて Contract 全体(外部からダミーXMLを流し込んでからDB永続化まで)の振る舞いを検証する。
3. **構造化ログの強制検証**: テスト実行時においても、必ず `context.Context` （独自の TraceID を内包）を引き回す。

---

## 2. パラメタライズドテストケース (Table-Driven Tests)

各Contractに対する入力（初期状態 + アクション）と期待されるアウトプット（戻り値 + 変更後の状態）を表として定義し、ループ内で検証する。

### 2.1 DictionaryBuilder 統合テスト
ダミーのxtranslator形式XMLデータを入力し、指定されたREC (例: `BOOK:FULL`, `NPC_:FULL` 等) が正しくフィルタリングされ、SQLiteの辞書DBへ永続化される一連のフローをテストする。

| ケースID | 目的                                                         | 初期状態 (入力/DB)                                                                                                   | アクション (関数呼出)                                                                    | 期待される結果 (出力 / 状態)                                                                                  |
| :------- | :----------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------ |
| DBS-01   | 正常系: 対象RECのみ抽出と保存                                | 空のDB。<br>対象REC(`BOOK:FULL`, `NPC_:FULL`)と対象外REC(`INFO:FULL`)が混在したXMLデータ。                           | `HandleImport`経由、または公開インターフェース(例: `ImportFromXML`)を通じたXML流し込み。 | エラーなし。<br>DBに対象RECのデータのみが保存され、対象外RECは無視されること。                                |
| DBS-02   | 正常系: 差分更新 (UPSERT)                                    | 既存レコード(`EDID: foo`, `REC: BOOK:FULL`, `Dest: 古い訳`)が存在するDB。<br>同じEDID/RECで新しい訳を持つXMLデータ。 | XML流し込み。                                                                            | エラーなし。<br>既存レコードの`Dest`などが新しい訳に更新(UPSERT)されていること。                              |
| DBS-03   | 異常系: 不正なXMLフォーマット                                | 空のDB。<br>タグが閉じていない等、パース不可能なXMLデータ。                                                          | XML流し込み。                                                                            | パースエラーが返却されること。<br>DBには何も保存されないこと。                                                |
| DBS-04   | 正常系: 大量データのストリーミング可否やバッチInsert動作確認 | 空のDB。<br>生成した大量の`DictTerm`要素群(擬似的な巨大XMLストリーム)。                                              | XML流し込み。                                                                            | メモリ枯渇(OOM)せずに全てのデータがDBに格納されること（バッチインサートやストリーミングパースの有効性確認）。 |
| DBS-05   | エッジケース: 空のパラメータ                                 | 空のDB。<br>`Addon`等のパラメータ要素が空となっているXMLデータ。                                                     | XML流し込み。                                                                            | エラーなし。<br>空のパラメータを含む形で正しくパース・DB保存されること。                                      |

---

## 3. 構造化ログとデバッグフロー (Log-based Debugging)

本スライスで不具合が発生した場合やテストが失敗した場合は、ステップ実行やユニットテストの追加による原因追及を行わず、実行生成物である構造化ログを用いたAIデバッグを徹底する。

### 3.1 テスト基盤でのログ準備
テストコードから Contract メソッドを呼び出す際は、サブテスト（Table-Drivenの各ケース）ごとに一意の TraceID を持つ `context.Context` を生成して引き回すこと。
各テスト実行時の `slog` の出力先はファイル（例: `logs/test_{timestamp}_DictionaryBuilder.jsonl`）に記録するようルーティングする。

### 3.2 AIデバッグプロンプトテンプレート
テスト失敗時やバグ発生時は、出力されたログと本仕様書を用いてAIにデバッグを依頼する。

```text
以下はスライス「DictionaryBuilderSlice」の実行ログファイル（logs/test_XXXXX_DictionaryBuilder.jsonl）の内容である。
仕様書（openspec/specs/DictionaryBuilderSlice/spec.md および 本テスト設計）の期待動作と比較し、乖離がある箇所を特定して修正コードを生成せよ。

--- 実行ログ ---
{ログファイル内容}

--- 期待される仕様 ---
{仕様書の該当セクション}
```
