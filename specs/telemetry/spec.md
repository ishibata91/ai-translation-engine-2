# テレメトリ (Telemetry) 仕様書

## 概要
システム全体の観測可能性（Observability）を向上させるための基盤コンポーネントである。ログ（Logs）、トレース（Traces）、メトリクス（Metrics）の収集と配信を統合的に扱う。当初は `logger` という名称であったが、単なるテキスト出力ではなく分散トレースやパフォーマンス情報の収集を含むため `telemetry` に改名された。

AIDD v2 の「ログファイル出力によるユニットテスト代替」および「TraceID による横断追跡」の要件を技術的に支える中心的なインフラである。

## 背景・動機
- **デバッグ容易性**: 複雑な垂直スライス間の連携を、一貫した TraceID で追跡できるようにする。
- **AIデバッグへの最適化**: AIが障害原因を特定しやすいよう、構造化されたログ（JSONL）をジョブ単位で出力・管理する。
- **パフォーマンス可視化**: 各処理の所要時間をメトリクスとして収集し、ボトルネックの特定を容易にする。

## スコープ
### 本コンポーネントが担う責務
1. **構造化ログ設定**: `log/slog` をベースに、JSON形式および人間が読みやすい形式のログハンドラを構成する。
2. **トレース基盤**: OpenTelemetry SDK を用いて、TraceID/SpanID の生成・伝播・エクスポートを管理する。
3. **ジョブ単位のログ出力**: セクション 6.2 ③ に基づき、`logs/{timestamp}_{job}.jsonl` へのファイル出力を制御する。
4. **コンテキスト連携**: `github.com/samber/slog-otel` 等を用いて、`context.Context` 内のトレース情報を自動的にログフィールドへ注入する。

### 本コンポーネントの責務外
- **ログの永続的なアーカイブ**: ローカルファイルへの出力は行うが、大規模なログ検索基盤（Elasticsearch等）への送信はプラグイン形式での拡張とする。

## 要件

### 1. 横断的な TraceID 付与
**Reason**: リクエストの開始から完了までのすべてのスライス・関数のログを紐付けるため。

#### Scenario: ログへのトレース情報自動注入
- **WHEN** `slog.InfoContext(ctx, "msg")` が呼び出された際
- **THEN** `ctx` に含まれる TraceID および SpanID を自動的に取得し、JSONのトップレベルフィールドとして出力する

### 2. 非同期エクスポート
**Reason**: テレメトリ収集自体のオーバーヘッドがアプリケーションのメインロジック（翻訳処理等）を遅延させないようにするため。

### 3. 動的なログレベル変更
**Reason**: 通常時は `INFO` レベルで運用し、必要に応じて設定変更なしで特定のパッケージのみ `DEBUG` 出力可能にするため。

## ログ出力・テスト共通規約

> 本インフラ層そのものが、プロジェクト全体のログ規約（`architecture.md` セクション 7）の実装体である。

### 実装時の義務
1.  **自己記述性**: テレメトリコンポーネント自身の初期化・エラーログも正確に出力されなければならない。
2.  **パッケージ `telemetry` の提供**: 他のパッケージからログハンドラの取得やトレースの開始を行うためのクリーンなインターフェースを提供する。
