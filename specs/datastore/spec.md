# データストア (Datastore) 仕様書

## 概要
システム全体のデータの永続化を担うインフラストラクチャ層のコンポーネントである。当初は `database` という名称であったが、リレーショナルデータベースに限らず、KeyValueストアやファイルベースの永続化など、より広範なデータ保存の抽象化を目的として `datastore` に改名された。

Interface-First AIDD v2 に基づき、各ドメインスライスに対して共通のデータベース接続、トランザクション管理、および永続化のための抽象化レイヤーを提供する。

## 背景・動機
- **共通基盤の提供**: 各スライスが個別にデータベース接続を管理するのではなく、一貫した接続プーリングとライフサイクル管理を提供する必要がある。
- **抽象化**: 具象的なデータベースエンジン（SQLite, PostgreSQL 等）への直接的な依存を避け、テスト時や将来の移行を容易にする。
- **トランザクション整合性**: 複数スライスにまたがる（または単一スライス内の複数操作）データ整合性を確保するためのトランザクション制御を標準化する。

## スコープ
### 本コンポーネントが担う責務
1. **接続管理**: 設定（`config` スライスより取得）に基づき、データベースへの接続を確立・保持する。
2. **接続プーリング**: リソースの効率的な利用のため、接続プールを管理する。
3. **DIによる提供**: 各スライスが `*sql.DB`（または抽象化されたインターフェース）を受け取れるよう Wire プロバイダーを提供する。
4. **テスト用DBの提供**: テスト環境において、インメモリDBや一時ファイルDBを即座に生成する機能を提供する。

### 本コンポーネントの責務外
- **具体的なスキーマ定義**: スキーマは各垂直スライス（VSAの原則）が個別に定義・管理する。
- **ドメインロジック**: データの意味内容に基づくバリデーションや加工はスライス側で行う。

## 要件

### 1. 接続管理と抽象化
**Reason**: 特定のDBエンジンへの密結合を防ぎ、環境に応じた柔軟な切り替えを可能にするため。

#### Scenario: 開発環境（SQLite）での接続
- **WHEN** アプリケーション設定で `driver: sqlite3` が指定された場合
- **THEN** 指定されたパスの SQLite ファイル（存在しない場合は新規作成）への接続を確立する
- **AND** 外部キー制約の有効化 (`PRAGMA foreign_keys = ON`) 等の初期設定を行う

### 2. トランザクション・ライフサイクル管理
**Reason**: データの一貫性を保証し、リソースリーク（接続の閉じ忘れ等）を防止するため。

#### Scenario: トランザクションの開始と終了
- **WHEN** スライスから `BeginTx(ctx)` が呼び出された場合
- **THEN** 新しいトランザクションインスタンスを返し、同一コンテキスト内での一貫した操作を可能にする
- **AND** `trace_id` を伝播させ、DB操作ログとアプリケーションログを紐付け可能とする

### 3. VSA原則に基づいた提供
**Reason**: 各スライスの独立性を保ちつつ、共通の接続リソースを再利用するため。

- 各スライスは `datastore.ProviderSet` を通じて `*sql.DB` を注入される。
- スライス側で `mod_terms` などのテーブルを独自に作成（`CREATE TABLE IF NOT EXISTS`）することを許容する。

## ログ出力・テスト共通規約

> 本インフラ層は `architecture.md` セクション 6（テスト戦略）・セクション 7（構造化ログ基盤）に準拠する。

### 実装時の義務
1.  **Entry/Exit ログ**: すべての公開メソッドで `slog.DebugContext(ctx, ...)` による入口・出口ログを出力する。
2.  **TraceID 伝播**: `context.Context` を通じて TraceID を SQL コメントやログに付与する。
3.  **テスト用DB**: `datastore_test.go` 等で、テスト実行ごとにクリーンな一時DBを提供するヘルパーを実装する。
