# テスト設計標準仕様 (Standard Test Spec)

本ドキュメントは、すべての Vertical Slice におけるテスト設計書（`{slice}_test_spec.md`）の標準的な記述フォーマットと要求事項を定義する。
`refactoring_strategy.md` の セクション 6（テスト戦略）および セクション 7（構造化ログ基盤）を具現化するための統一規格である。

---

## 1. ドキュメント構成要件

テスト設計書は、必ず以下の章立てで構成すること。

1. **章タイトルの直下に準拠宣言**:
   `refactoring_strategy.md` に準拠している旨と、本質的な方針（ユニットテスト廃止、パラメタライズドテスト、構造化ログ）を明記する。
2. **テスト方針**:
   そのスライス固有のテスト方針（インメモリDBの利用、モックの利用など）を定義する。
3. **パラメタライズドテストケース (Table-Driven Tests)**:
   テストケースを **Markdown テーブル形式** で網羅的に記述する。
4. **構造化ログとデバッグフロー**:
   AIデバッグのためのトレース伝播を明記する。

---

## 2. 記述フォーマットテンプレート

以下は、新規のテスト設計書を作成する際のコピーペースト用テンプレートである。


# {スライス名} テスト設計 ({SliceName} Test Spec)

本設計は `refactoring_strategy.md` セクション 6（テスト戦略）および セクション 7（構造化ログ基盤）に厳密に準拠し、個別関数の細粒度なユニットテストを作成せず、Vertical Slice の Contract に対する網羅的なパラメタライズドテスト（Table-Driven Test）を定義する。

## 1. テスト方針

1. **細粒度ユニットテストの排除**: 内部処理や個別関数単位の振る舞いテストは作成しない。
2. **網羅的パラメタライズドテスト**: すべてのテストを Table-Driven Test として実装し、インメモリ SQLite (`:memory:`) または適切なモック（外部呼び出しの場合のみ）を用いて Contract 全体の振る舞いを検証する。
3. **構造化ログの強制検証**: テスト実行時においても、必ず `context.Context` （独自の TraceID を内包）を引き回す。

---

## 2. パラメタライズドテストケース (Table-Driven Tests)

各Contractに対する入力（初期状態 + アクション）と期待されるアウトプット（戻り値 + 変更後の状態）を表として定義し、ループ内で検証する。

### 2.1 {対象とするコンポーネント・Contract名} 統合テスト
{テストの目的と概要}

| ケースID  | 目的                    | 初期状態 (入力/DB) | アクション (関数呼出)  | 期待される結果 (出力 / 状態)         |
| :-------- | :---------------------- | :----------------- | :--------------------- | :----------------------------------- |
| {PRFX}-01 | {テストの意図・正常系1} | {前提となるデータ} | `{メソッド名}({引数})` | {戻り値・副作用}                     |
| {PRFX}-02 | {テストの意図・異常系1} | {前提となるデータ} | `{メソッド名}({引数})` | {期待されるエラー}。パニックしない。 |

（※必要に応じてコンポーネントごとに 2.2, 2.3... とセクションを分ける）

---

## 3. 構造化ログとデバッグフロー (Log-based Debugging)

本スライスで不具合が発生した場合やテストが失敗した場合は、ステップ実行やユニットテストの追加による原因追及を行わず、実行生成物である構造化ログを用いたAIデバッグを徹底する。

### 3.1 テスト基盤でのログ準備
テストコードから Contract メソッドを呼び出す際は、サブテスト（Table-Drivenの各ケース）ごとに一意の TraceID を持つ `context.Context` を生成して引き回すこと。
各テスト実行時の `slog` の出力先はファイル（例: `logs/test_{timestamp}_{SliceName}.jsonl`）に記録するようルーティングする。
