# LLMクライアント テスト設計 (LLMClient Test Spec)

本設計は `architecture.md` セクション 6（テスト戦略）および セクション 7（構造化ログ基盤）に厳密に準拠し、個別関数の細粒度なユニットテストを作成せず、Vertical Slice の Contract に対する網羅的なパラメタライズドテスト（Table-Driven Test）を定義する。

## 1. テスト方針

1. **細粒度ユニットテストの排除**: リクエスト・レスポンスの変換ロジック等の個別関数単位の振る舞いテストは作成しない。
2. **網羅的パラメタライズドテスト**: すべてのテストを Table-Driven Test として実装する。外部API通信を行う責務を持つため、実際の通信は行わず `net/http/httptest` を用いたモックサーバー、または独自に定義したモックプロバイダーインターフェースを差し込むことで、Contract 全体(リクエスト構築〜送信〜レスポンスパース〜エラーハンドリング)の振る舞いを検証する。
3. **構造化ログの強制検証**: テスト実行時においても、必ず `context.Context` （独自の TraceID を内包）を引き回す。

---

## 2. パラメタライズドテストケース (Table-Driven Tests)

各Contractに対する入力（初期状態 + アクション）と期待されるアウトプット（戻り値 + 変更後の状態）を表として定義し、ループ内で検証する。

### 2.1 LLMClient.Complete 統合テスト
単一のリクエストを送信し、結果やエラーを取得する一連のフローをテストする。

| ケースID | 目的                           | 初期状態 (入力/モックDB設定等)                                                          | アクション (関数呼出)    | 期待される結果 (出力 / 状態)                                                                                     |
| :------- | :----------------------------- | :-------------------------------------------------------------------------------------- | :----------------------- | :--------------------------------------------------------------------------------------------------------------- |
| LLM-01   | 正常系: 正当なリクエスト       | HTTPモックサーバーがステータス200と静的な生成テキストを返却するよう設定。               | `Complete(ctx, request)` | エラーなし。<br>生成テキストがパースされて返されること。                                                         |
| LLM-02   | 正常系: 構造化出力 (JSON)      | HTTPモックサーバーが有効なJSON文字列を返却するよう設定。                                | `Complete(ctx, request)` | エラーなし。<br>レスポンスが指定されたスキーマ/型パラメータに適合するJSONとして返却されること。                  |
| LLM-03   | 異常系: APIタイムアウト        | HTTPモックサーバーがレスポンス遅延を起こすよう設定、または Context でタイムアウト指定。 | `Complete(ctx, request)` | 適切なタイムアウトエラー (`context.DeadlineExceeded` 等) が返却されること。                                      |
| LLM-04   | 異常系: 認証エラーや権限エラー | HTTPモックサーバーがHTTPステータス 401 Unauthorized を返却するよう設定。                | `Complete(ctx, request)` | ラップされた認証エラーが返却されること。パニックしない。                                                         |
| LLM-05   | 異常系: レートリミット (429)   | HTTPモックサーバーがHTTPステータス 429 Too Many Requests を返却するよう設定。           | `Complete(ctx, request)` | 再試行が必要であることを示すエラー(またはリトライロジックを実装している場合はリトライ後の結果)が返却されること。 |
| LLM-06   | 異常系: 空のプロンプト         | HTTPモックへ到達する前に、バリデーションで弾かれる設定。                                | `Complete(ctx, request)` | 即座にバリデーションエラーが返却され、モックサーバーへは通信が行われないこと。                                   |

### 2.2 BatchClient 統合テスト — 共通
バッチAPIのジョブ投入、ステータス確認および結果取得フローの共通ケース。

| ケースID | 目的                     | 初期状態 (入力/モックDB設定等)                                                 | アクション (関数呼出)      | 期待される結果 (出力 / 状態)                                                       |
| :------- | :----------------------- | :----------------------------------------------------------------------------- | :------------------------- | :--------------------------------------------------------------------------------- |
| BT-01    | 正常系: バッチ投入       | モックサーバーが BatchJobID を払い出すよう設定。                               | `SubmitBatch(ctx, reqs)`   | エラーなし。<br>正しい `BatchJobID` が返却されること。                             |
| BT-02    | 正常系: 結果取得         | モックサーバーが完了済みステータスと、パース可能な結果配列を返却するよう設定。 | `GetBatchResults(ctx, id)` | エラーなし。<br>要求した全件を含む配列・リストとして結果が正しくパースされること。 |
| BT-03    | 異常系: 不明なジョブ照会 | モックサーバーが 404 Not Found を返却するよう設定。                            | `GetBatchResults(ctx, id)` | エラー(Not Found等)が返却されること。パニックしない。                              |

### 2.3 xAI BatchClient 専用テスト — 独自フォーマット検証
xAI Batch API は OpenAI Batch API と非互換のため、独自のフォーマット検証テストを追加する。

| ケースID | 目的                                                 | 初期状態                                                                                     | アクション                          | 期待される結果                                                                                                |
| :------- | :--------------------------------------------------- | :------------------------------------------------------------------------------------------- | :---------------------------------- | :------------------------------------------------------------------------------------------------------------ |
| XB-01    | 正常系: バッチ作成レスポンスが `batch_id` キーを使用 | モックサーバーが `{"batch_id": "grok-batch-xxx"}` を返却                                     | `SubmitBatch` 内部の `_createBatch` | `id` でなく `batch_id` フィールドを読み取り、正しく `BatchJobID` が返ること                                   |
| XB-02    | 正常系: リクエスト追加が独自形式で送信される         | モックサーバーがリクエストボディをキャプチャ                                                 | `SubmitBatch(ctx, reqs)`            | `POST /v1/batches/{id}/requests` に `batch_requests[].batch_request.chat_get_completion` 形式で送信されること |
| XB-03    | 正常系: ステータスを `state.*` フィールドから導出    | `state.num_pending=0, num_success=5, num_error=0` を返却                                     | `GetBatchStatus(ctx, id)`           | `BatchStatus.State == "completed"` と導出されること                                                           |
| XB-04    | 正常系: ページネーション全件取得                     | 1ページ目: `pagination_token="page2"` 付き結果3件、2ページ目: `pagination_token` なし結果2件 | `GetBatchResults(ctx, id)`          | 合計5件すべてが `[]Response` として返却されること                                                             |
| XB-05    | 正常系: 結果パスの正確な抽出                         | `batch_result.response.chat_get_completion.choices[0].message.content` にテキストあり        | `GetBatchResults(ctx, id)`          | `Response.Content` に正しく内容が取り込まれること                                                             |
| XB-06    | 異常系: Batch非対応モデル (`grok-3-mini`)            | `LLMConfig.Model = "grok-3-mini"`                                                            | `GetBatchClient(ctx, config)`       | エラーまたは警告が返却されること                                                                              |
| XB-07    | 異常系: バッチ作成失敗後のフォールバック             | 1チャンク目の `_addRequests` が 400 を返却                                                   | `SubmitBatch(ctx, reqs)`            | 新規バッチを作成して残りリクエストを続行するか、エラーが返ること（フォールバック）                            |

---

## 3. 構造化ログとデバッグフロー (Log-based Debugging)

本スライスで不具合が発生した場合やテストが失敗した場合は、ステップ実行やユニットテストの追加による原因追及を行わず、実行生成物である構造化ログを用いたAIデバッグを徹底する。

### 3.1 テスト基盤でのログ準備
テストコードから Contract メソッドを呼び出す際は、サブテスト（Table-Drivenの各ケース）ごとに一意の TraceID を持つ `context.Context` を生成して引き回すこと。
各テスト実行時の `slog` の出力先はファイル（例: `logs/test_{timestamp}_LLMClient.jsonl`）に記録するようルーティングする。

### 3.2 AIデバッグプロンプトテンプレート
テスト失敗時やバグ発生時は、出力されたログと本仕様書を用いてAIにデバッグを依頼する。

```text
以下はスライス「LLMClient」の実行ログファイル（logs/test_XXXXX_LLMClient.jsonl）の内容である。
仕様書（openspec/specs/LLMClient/llm_client_interface.md および 本テスト設計）の期待動作と比較し、乖離がある箇所を特定して修正コードを生成せよ。

--- 実行ログ ---
{ログファイル内容}

--- 期待される仕様 ---
{仕様書の該当セクション}
```
