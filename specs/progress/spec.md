# プログレス (Progress) 仕様書

## 概要
長時間実行される処理（データロード、用語抽出、LLM翻訳等）の進捗状況を収集・集約し、リアルタイムで外部（フロントエンド等）に通知するためのインフラストラクチャコンポーネントである。

ドメインスライスが進捗を報告する際の標準的なメソッドを提供し、UIがユーザーに対して「現在何が行われているか」を正確に提示できるようにする。

## 背景・動機
- **ユーザー体験**: LLM翻訳のように数分〜数時間かかる処理において、沈黙は不安を招く。詳細な進捗表示（例: 125/1500 レコード完了）が必須である。
- **責務の分離**: 進捗の「集計（どのスライスがどの程度進んだか）」と「配信（WebSocket/Server-Sent Events）」のロジックをインフラ層に集約し、ドメインスライスを配信プロトコル（UI実装の詳細）から隔離する。

## スコープ
### 本コンポーネントが担う責務
1. **進捗の受信**: 各スライスからの進捗報告（完了数、総数、現在のアクション名）を受理する。
2. **進捗の集計**: 複数の並列タスクがある場合、それらを統合した全体進捗率を計算する。
3. **通知の配信**: 受信した進捗情報を、登録されたリスナー（UIのWebSocket接続等）へブロードキャストする。
4. **履歴管理**: 実行中のジョブの直近の進捗状態を保持する。

### 本コンポーネントの責務外
- **具体的な処理の実行**: 実際に何パーセント進んだかを計算するための元データは、実行中のスライスが提供する。

## 要件

### 1. ドメイン非依存の進捗報告インターフェース
**Reason**: あらゆる種類のタスク（ファイル処理、API待機、DB書き込み）で同一の報告方法を可能にするため。

#### Scenario: 翻訳スライスからの進捗報告
- **WHEN** 翻訳スライスがバッチ結果を1件保存した際
- **THEN** `ReportProgress(ctx, jobID, sliceName, current, total, "Saving result...")` を呼び出す
- **AND** プログレスハブは即座にこれを全リスナーへ配信する

### 2. 並列ジョブの同時追跡
**Reason**: 複数のModを並行してロード・処理している場合でも、それぞれの進捗を混同せずに個別管理するため。

#### Scenario: 複数ファイルロードの並列表示
- **WHEN** 異なる `jobID` を持つ報告が同時に発生した場合
- **THEN** 各 `jobID` ごとに進捗状態を独立して保持・配信する

## ログ出力・テスト共通規約

> 本インフラ層は `architecture.md` セクション 6（テスト戦略）・セクション 7（構造化ログ基盤）に準拠する。

### 実装時の義務
1.  **軽量性**: 進捗通知が頻繁（1秒間に数十回等）に発生しても、メイン処理のパフォーマンスを阻害しないよう、通知処理は非同期（Channel等）で行う。
2.  **型安全性**: 通知されるメッセージフォーマットを JSON スキーマ等で明確に定義する。
