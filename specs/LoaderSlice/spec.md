# Loader Slice アーキテクチャ
> Interface-First AIDD: Loader 垂直スライス

## 目的
TBD: ローダーモジュールに対する依存性注入の提供、および内部データ処理の隠蔽（カプセル化）。

## 要件

### 要件: Loader出力の独自DTO定義とグローバルドメイン依存の排除
**理由**: VSA（Vertical Slice Architecture）の原則に従い、システム全体で共有するデータモデル（`pkg/domain` 等）を排除し、各スライスが自身の入出力構造を独自定義する設計（Anti-Corruption Layer）へ移行するため。
**移行**: これまでパース結果を格納するために利用していた `pkg/domain` などの外部依存モデルを破棄し、本スライスの `contract.go` パッケージ内に独自定義した出力専用DTOを返すようにインターフェースおよび内部実装を修正する。

#### シナリオ: 独自定義DTOによるパース結果の返却
- **WHEN** Modファイル群のロードおよびパース処理が完了した場合
- **THEN** 外部パッケージのモデルに一切依存することなく、本スライス内部で定義された独自DTOに全データを格納して返却できること

### 要件: Loader スライス DI プロバイダー
`pkg/loader` モジュールは、Google Wire を介して依存性注入プロバイダー関数を提供し、その内部実装の詳細を隠蔽しなければならない。

#### シナリオ: DI 初期化
- **WHEN** アプリケーションが起動し、コンポーネントを初期化する場合
- **THEN** 内部構造体を直接インスタンス化することなく、モジュールの Wire プロバイダーを通じて `contract.Loader` を解決する。

### 要件: 内部プロセスのカプセル化
順次ロードと並列デコードの手順は、`contract.Loader` の実装内にカプセル化され、Process Manager に公開されてはならない。

#### シナリオ: ロードプロセスのオーケストレーション
- **WHEN** Process Manager が `LoadExtractedJSON` を呼び出す場合
- **THEN** スライス内部でファイルの読み込み、デコード、構造化を調整し、最終的な `ExtractedData` またはエラーのみを返す。

### 要件: 階層的コンテキストのための Loader DTO 拡張
Loader スライスは、完全な翻訳コンテキストと将来のエクスポート処理に必要な階層的データ関係をキャプチャする、堅牢なデータ転送オブジェクト（DTO）を定義・入力しなければならない。

#### シナリオ: 階層的なクエスト項目の DTO への入力
- **WHEN** 抽出スクリプトから DTO にデータをロードする場合
- **THEN** Loader スライスは、`QuestStage` と `QuestObjective` の構造を拡張し、親クエストの `ID` と `EditorID` を保存できるようにする
- **AND** データロードプロセス中にこれらのフィールドに値を入力する

### 要件: データ抽出の前提条件と厳密なパース
Loader スライスは、入力される JSON ペイロード（`extractData.pas` によって生成される）に、インデックスの衝突とレスポンスの順序に関する修正が含まれていることを前提としなければならない。

#### シナリオ: 抽出された JSON の正しいパース
- **WHEN** Pascal 抽出スクリプトから JSON ペイロードをロードする場合
- **THEN** Loader スライスは、衝突を防ぐために `stage_index` と `log_index` を別のフィールドとしてパースする
- **AND** 正確なツリー探索と順序を保証するために、会話レスポンスの明示的な `order`（または `index`）フィールドをパースする

---

## ログ出力・テスト共通規約

> 本スライスは `refactoring_strategy.md` セクション 6（テスト戦略）・セクション 7（構造化ログ基盤）に準拠する。

### 実装時の義務

1.  **パラメタライズドテスト**: テストは Table-Driven Test で網羅的に行い、細粒度のユニットテストは作成しない（セクション 6.1）。
2.  **Entry/Exit ログ**: 全 Contract メソッドおよび主要内部関数で `slog.DebugContext(ctx, ...)` による入口・出口ログを出力する（セクション 6.2 ①）。
3.  **TraceID 伝播**: 公開メソッドは第一引数に `ctx context.Context` を受け取り、OpenTelemetry TraceID を全ログに自動付与する（セクション 7.3）。
4.  **ログファイル出力**: 実行単位ごとに `logs/{timestamp}_{slice_name}.jsonl` へ debug 全量を記録する（セクション 6.2 ③）。
5.  **AI デバッグプロンプト**: 障害時は定型プロンプト（セクション 6.2 ④）でログと仕様書をAIに渡し修正させる。
