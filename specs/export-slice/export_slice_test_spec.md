# XMLエクスポート テスト設計 (ExportSlice Test Spec)

本設計は `architecture.md` セクション 6（テスト戦略）および セクション 7（構造化ログ基盤）に厳密に準拠し、個別関数の細粒度なユニットテストを作成せず、Vertical Slice の Contract に対する網羅的なパラメタライズドテスト（Table-Driven Test）を定義する。

## 1. テスト方針

1. **細粒度ユニットテストの排除**: 内部処理（`ResultMerger`, `XMLFormatter`, `FileWriter`）や個別関数単位の振る舞いテストは作成しない。
2. **網羅的パラメタライズドテスト**: すべてのテストを Table-Driven Test として実装し、`ExportGenerator.GenerateXML` にさまざまな `ExportInput` を与えたとき、出力されるXMLファイルの内容が仕様通りであるかを検証する。
3. **ファイルI/Oのモック化/一時ファイル利用**: ファイルの出力先には `t.TempDir()` などで作成した一時ディレクトリを指定し、出力されたXMLの内容をパースして期待値と比較する。
4. **構造化ログの強制検証**: テスト実行時においても、必ず `context.Context` （独自の TraceID を内包）を引き回す。

---

## 2. パラメタライズドテストケース (Table-Driven Tests)

各Contractに対する入力（初期状態 + アクション）と期待されるアウトプット（戻り値 + 変更後の状態）を表として定義し、ループ内で検証する。

### 2.1 ExportGenerator 統合テスト
`ExportInput` から XMLファイルが正しく生成されること、および重複排除ロジックを検証する。

| ケースID | 目的                                           | 初期状態 (入力)                                                                                                                                                                          | アクション (関数呼出)   | 期待される結果 (出力 / 状態)                                                                                                                                                                            |
| :------- | :--------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| EXP-01   | 正常系: 用語・本文ともにデータあり（重複なし） | `TermResults` に 1件、`MainResults` に 1件の異なるEDIDを持つデータを含む `ExportInput`。<br>Plugin="Skyrim.esm", Src="english", Dest="japanese"                                          | `GenerateXML(ctx, in)` | エラーなし。<br>出力されたXMLが整形式であり、`<Params>`が正しく設定されていること。<br>`<Content>` 内に2つの `<String>` 要素が含まれること。                                                            |
| EXP-02   | 異常系: 用語・本文で重複がある場合（設定ミス） | `TermResults` と `MainResults` に**同じ `EditorID` と `RecordType`** を持つデータを含む。<br>例：用語="鉄の剣", 本文="鉄の剣(本文調整済)"                                                | `GenerateXML(ctx, in)` | エラーなし、だが内部で警告ログが出力される。<br>出力XML内の対象 `<String>` 要素は1つのみであり、後勝ち（`MainResults` の値 "鉄の剣(本文調整済)"）になっていること。                                     |
| EXP-03   | 正常系: XMLエスケープ文字を含むテキスト        | `MainResults` に `<font color='red'>Fire</font> & Ice` のようなテキストを含む。                                                                                                          | `GenerateXML(ctx, in)` | エラーなし。<br>出力XMLの `<Source>` および `<Dest>` 内の特殊文字が正しくXMLエスケープ (`<`, `>`, `&` 等) されていること。<br>（出力ファイルを再度 `xml.Unmarshal` して元の文字列に戻るか確認） |
| EXP-04   | 正常系: 片方の結果が空の場合                   | `TermResults` が空、`MainResults` のみデータを含む。                                                                                                                                     | `GenerateXML(ctx, in)` | エラーなし。<br>`MainResults` のデータのみが正しくXML化されて出力されること。                                                                                                                           |
| EXP-05   | 正常系: SID連番の確認                          | 複数のレコードを含む `ExportInput`。                                                                                                                                                     | `GenerateXML(ctx, in)` | エラーなし。<br>出力XML内の各 `<String>` 要素の `sID` 属性が `000001`, `000002` のように連番で付与されていること。                                                                                      |
| EXP-06   | 異常系: 不正な出力パス                         | `OutputFilePath` に書き込み権限のないディレクトリ、または不正なパスを指定。                                                                                                              | `GenerateXML(ctx, in)` | ファイル作成に失敗し、適切なエラーが返ること。パニックしない。                                                                                                                                          |

---

## 3. 構造化ログとデバッグフロー (Log-based Debugging)

本スライスで不具合が発生した場合やテストが失敗した場合は、ステップ実行やユニットテストの追加による原因追及を行わず、実行生成物である構造化ログを用いたAIデバッグを徹底する。

### 3.1 テスト基盤でのログ準備
テストコードから Contract メソッドを呼び出す際は、サブテスト（Table-Drivenの各ケース）ごとに一意の TraceID を持つ `context.Context` を生成して引き回すこと。
各テスト実行時の `slog` の出力先はファイル（例: `logs/test_{timestamp}_ExportSlice.jsonl`）に記録するようルーティングする。

### 3.2 AIデバッグ専用プロンプトの定型化
障害発生時、またはテスト失敗時には、該当ジョブのログファイルをそのままAIに渡し、以下の定型プロンプトを用いたデバッグと修正指示を行う。

```text
以下はスライス「Export Slice」の実行ログファイル（logs/{LogFilePath}）の内容である。
仕様書（openspec/specs/ExportSlice/spec.md）の期待動作と比較し、乖離がある箇所を特定して修正コードを生成せよ。

--- 実行ログ ---
{ログファイル内容}

--- 期待される仕様 ---
{仕様書の該当セクション}
```
