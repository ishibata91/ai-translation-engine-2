# Parser テスト設計 (Parser Test Spec)

本設計は `architecture.md` セクション 6（テスト戦略）および セクション 7（構造化ログ基盤）に厳密に準拠し、個別関数の細粒度なユニットテストを作成せず、Vertical Slice の Contract に対する網羅的なパラメタライズドテスト（Table-Driven Test）を定義する。

## 1. テスト方針

1. **細粒度ユニットテストの排除**: 内部のモデルのヘルパーメソッド（例: `IsFemale`等）や、ファイル読み込み・デコード・エンコーディング判定の個別関数に対する単体テストは作成しない。
2. **網羅的パラメタライズドテスト**: すべてのテストを Table-Driven Test として実装し、`contract.Parser` (具体的には `LoadExtractedJSON` メソッド) の入力（ダミーファイルやオンメモリバッファのJSON）から出力（`ExtractedData` またはエラー）までの一連の流れを検証する。DBアクセスは持たないためインメモリDBは不要だが、純粋な入力から出力への変換フローをテストする。
3. **構造化ログの強制検証**: テスト実行時においても、必ず `context.Context` （独自の TraceID を内包）を引き回す。

---

## 2. パラメタライズドテストケース (Table-Driven Tests)

各Contractに対する入力（初期状態 + アクション）と期待されるアウトプット（戻り値 + 変更後の状態）を表として定義し、ループ内で検証する。

### 2.1 parser.LoadExtractedJSON 統合テスト
入力されたJSONストリームまたはファイルパスから、正しくデコードされてスキーマ通りの `ExtractedData` ドメインモデルが生成されるフローをテストする。

| ケースID | 目的                                           | 初期状態 (入力JSONデータ)                                                                                               | アクション (関数呼出)            | 期待される結果 (出力 / 状態)                                                                                      |
| :------- | :--------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------- | :------------------------------- | :---------------------------------------------------------------------------------------------------------------- |
| LDR-01   | 正常系: 基本ロード (UTF-8)                     | 有効な構造を持つ標準的なUTF-8エンコードのJSON文字列またはファイル。                                                     | `LoadExtractedJSON(ctx, source)` | エラーなし。<br>全フィールドが欠落なく `ExtractedData` として構造体に格納されること。                             |
| LDR-02   | 正常系: BOM付き UTF-8                          | 先頭にBOMが存在するUTF-8のメタデータ付きJSON。                                                                          | `LoadExtractedJSON(ctx, source)` | エラーなし。<br>BOMが正しく無視され、正常にパースされて構造体に格納されること。                                   |
| LDR-03   | 正常系: 自動エンコーディング検知 (Shift-JIS等) | 指定以外のエンコーディング（SJIS等）で保存されたJSONファイル。                                                          | `LoadExtractedJSON(ctx, source)` | エラーなし。<br>文字化けを起こすことなく、内部でUTF-8化して正常にパース・格納されること。                         |
| LDR-04   | 正常系: 部分的な構成のデータ                   | 必須項目以外のキーが欠落している（例: "quests" キーのみ存在する等）JSON。                                               | `LoadExtractedJSON(ctx, source)` | エラーなし。<br>存在する項目(quests)のみ値が入り、他は空スライス/nilとして格納されること。パニックしない。        |
| LDR-05   | 正常系: データ正規化・フィルタリング検証       | "EditorID抽出が必要な形式 (`Name [VTYP:123]`)" や "対象外となる不要データ(すでに日本語を含むレコード)" が混在したJSON。 | `LoadExtractedJSON(ctx, source)` | エラーなし。<br>EditorIDが抽出・正規化されており、フィルタリング対象のデータは `ExtractedData` に含まれないこと。 |
| LDR-06   | 異常系: ファイル不在                           | 存在しないパス（ファイル入力の場合）。                                                                                  | `LoadExtractedJSON(ctx, source)` | `FileNotFoundError` 相当の適切なファイル読み込みエラーが返却されること。                                          |
| LDR-07   | 異常系: 不正なJSON構文                         | 中途半端に切れている、カンマが抜けている等、JSONとしてパース不可能なデータ。                                            | `LoadExtractedJSON(ctx, source)` | `JSONDecodeError` 相当のパースエラーが返却されること。パニックしない。                                            |
| LDR-08   | 異常系: 空のファイル/データ                    | サイズが0バイトの空ファイル、または空の文字列。                                                                         | `LoadExtractedJSON(ctx, source)` | 空である旨のエラー、またはデータ無しの `ExtractedData` (仕様に基づく) が安全に返却されること。                    |

---

## 3. 構造化ログとデバッグフロー (Log-based Debugging)

本スライスで不具合が発生した場合やテストが失敗した場合は、ステップ実行やユニットテストの追加による原因追及を行わず、実行生成物である構造化ログを用いたAIデバッグを徹底する。

### 3.1 テスト基盤でのログ準備
テストコードから Contract メソッドを呼び出す際は、サブテスト（Table-Drivenの各ケース）ごとに一意の TraceID を持つ `context.Context` を生成して引き回すこと。
各テスト実行時の `slog` の出力先はファイル（例: `logs/test_{timestamp}_LoaderSlice.jsonl`）に記録するようルーティングする。

### 3.2 AIデバッグプロンプトテンプレート
テスト失敗時やバグ発生時は、出力されたログと本仕様書を用いてAIにデバッグを依頼する。

```text
以下はスライス「Parser」の実行ログファイル（logs/test_XXXXX_LoaderSlice.jsonl）の内容である。
仕様書（openspec/specs/Parser/spec.md および 本テスト設計）の期待動作と比較し、乖離がある箇所を特定して修正コードを生成せよ。

--- 実行ログ ---
{ログファイル内容}

--- 期待される仕様 ---
{仕様書の該当セクション}
```
