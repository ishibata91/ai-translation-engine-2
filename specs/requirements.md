# Skyrim Mod Translation Engine (v2.0) 要件定義書

## 1. はじめに

### 1.1 目的
本ドキュメントは、Skyrim Mod自動翻訳エンジン「translate_with_local_ai.py (v2.0)」の要件定義をまとめたものである。本システムは、生成AIを活用し、従来の単純な機械翻訳では達成できなかった「文脈（Context）を考慮した高品質な日本語翻訳」を実現することを目的とする。

### 1.2 背景と課題
従来の翻訳手法（v1.x、ベクトル類似度検索など）には以下の課題が存在した。
1.  **同義語ノイズ**: "Iron Sword"（鉄の剣）の検索等で、類似するが異なる単語（例: "Steel Sword"）が誤って参照され、翻訳精度が低下する。
2.  **文脈の欠如**: 誰が誰に話しているか、前後の会話はどうなっているかが考慮されず、不自然な会話文が生成される。
3.  **スタイルの不一致**: 屈強な戦士が貴族のような口調で話すなど、キャラクターの属性（種族、性格）が反映されない。

### 1.3 スコープ
*   **対象**: Skyrim Special Edition (SE/AE) の Mod ファイル (.esp/.esm/.esl)。
*   **処理範囲**: xEditによるデータ抽出から、AIによる翻訳、配布形式へのエクスポートまで。
*   **利用技術**: 生成AI（LLM）を用いた文脈解釈型翻訳。

---

## 2. システム概要

### 2.1 コンセプト
**「構造的コンテキスト解析 (Structured Context Analysis)」** を核とする。単なるテキスト置換ではなく、ゲームデータの構造（会話ツリー、クエスト進行、NPC属性）を解析し、翻訳に必要な「文脈」をAIに提供する。

### 2.2 アーキテクチャ: 2-Pass System
品質と一貫性を担保するため、処理を2段階に分割する。

*   **Pass 1: 用語翻訳と構造化 (Term Translation & Structuring)**
    *   固有名詞（NPC名、アイテム名、場所名）を先行して翻訳し、辞書キャッシュを構築する。
    *   会話データ等の依存関係を解析し、構造化データを作成する。
*   **Pass 2: 本文翻訳 (Main Translation)**
    *   Pass 1で構築した用語辞書と文脈情報を用いて、会話文や説明文を翻訳する。

---

## 3. 機能要件

### 3.1 データ入力とロード
*   **抽出データ読み込み**: xEditスクリプトによって出力されたデータ（JSON等）を読み込むことができること。
*   **複数ファイル対応**: 複数の入力ファイルを一括でロードし、処理できること。
*   **データバリデーション**: 読み込み時にデータの整合性をチェックし、不正なレコードを除外または報告すること。
*   **外部辞書作成 (Dictionary Builder)**: xTranslator形式のXMLファイルを読み込み、名詞類（NPC名、アイテム名など）を抽出してSQLiteベースの用語辞書DBを構築する独立機能（Slice）を備えること。

### 3.2 コンテキスト構築 (Context Building)
*   **会話ツリー解析**: `DIAL/INFO` レコードの親子関係 (`PNAM`) を追跡し、直前の発言（Previous Line）を特定できること。
*   **話者プロファイリング (Speaker Profiling)**:
    *   NPCの種族 (`RNAM`)、声の種類 (`VTCK`)、性別フラグ (`ACBS`) から、適切な口調（Tone）を推定すること。
    *   例：「カジート」→「〜とお前は思う」、「オーク」→「粗野な口調」。
    *   ユーザーによるカスタマイズ設定（特定のNPCへの口調強制など）を可能にすること。
*   **NPCペルソナ生成 (NPC Persona Generation)**:
    *   NPCごとに会話データ（`DIAL/INFO`）を最大100件まで収集し、LLMにリクエストしてそのNPCの性格・口調・背景を要約した「ペルソナ」を自動生成すること。
    *   ペルソナ生成前に、NPCごとの会話データ量から想定トークン利用量を計算し、LLMのコンテキスト長制限を超過しないか事前評価できること。
    *   コンテキスト長超過が見込まれる場合は、会話データの優先度付き選別（直近・重要度順）またはユーザーへの警告を行うこと。
    *   生成されたペルソナはPass 2の本文翻訳時に話者プロファイルとして参照され、翻訳の口調一貫性を向上させること。
*   **クエスト要約 (Quest Summarization)**:
    *   クエストステージ (`QUST INDX`) を時系列順に処理し、過去のステージの翻訳結果を「これまでのあらすじ」として累積的に次ステージのコンテキストに含めること。
*   **用語抽出と検索**:
    *   翻訳対象テキストからキーワードを抽出し、辞書から関連用語を検索・提示すること。
    *   完全一致（Exact Match）を最優先し、ハルシネーション（幻覚）を防止すること。

### 3.3 翻訳エンジン (Translator)
*   **AI連携**: APIを通じて生成AI（LLM）に接続し、翻訳を実行できること。
*   **プロンプトエンジニアリング**: レコード種別（会話、武器、本など）に応じた最適なシステム指示を動的に生成すること。
*   **タグ処理**:
    *   ゲーム内特有のタグ（`<font>`, `<alias>`等）や制御文字を翻訳前に保護（抽象化）し、翻訳後に復元することで、データの破損を防ぐこと。
    *   書籍 (`BOOK`) データについては、構造を維持したまま長文分割（Chunking）処理を行うこと。
*   **リトライとリカバリ**:
    *   AIの応答エラーやフォーマット不正時に、パラメータを調整しながら自動リトライを行うこと。
    *   一時的な通信エラー等に耐性を持つこと。

### 3.4 ユーザーインターフェース (UI)
*   **GUI操作**: ユーザーが直感的に操作できるグラフィカルインターフェースを提供すること。
*   **LLMモード選択**: 全てのLLM利用ユースケースにおいて、同じモーダルUIなどからローカル、Gemini、xAI、バッチAPIモードなどを選択・切り替え可能とすること。
*   **進捗可視化**: 全体およびファイルごとの進捗状況をリアルタイムで表示すること。
*   **プレビュー機能**: 翻訳実行前に、生成されたコンテキストやAIへの指示内容を確認できること。
*   **設定管理**: エンジンの挙動に関する設定を変更できること。
*   **プロンプトテンプレート調整**: レコード種別（会話、武器、本など）ごとのシステムプロンプトテンプレートをUI上で閲覧・編集できること。変更内容はConfig Storeに永続化され、翻訳エンジンが動的に参照すること。

### 3.5 エクスポート (Output)
*   **配布形式出力**: Mod翻訳コミュニティで標準的な形式（JSON等）で出力すること。
*   **xTranslator互換性**: xTranslator互換のXML形式(SSTXMLRessources)を出力する Export Slice を備えること。
    *   **シナリオ: 翻訳出力の生成**: 翻訳プロセスが正常に完了した際、Export Sliceを介してxTranslator互換のXML (SSTXMLRessources) を出力しなければならない。
*   **FormID正規化**: ロードオーダーに依存しない形式（例: `0x001234|ModName.esp`）にIDを変換すること。
*   **差分更新 (Resume)**: 既に翻訳済みの出力ファイルが存在する場合、成功したレコードは維持し、未翻訳または失敗したレコードのみを更新・追記できること。

### 3.6 用語キャッシュ管理 (Term Cache)
*   **Mod用語キャッシュ**: そのMod内で登場する固有名称（NPC名など）を翻訳・キャッシュし、即座にそのMod内の会話翻訳で参照できるようにすること。

### 3.7 NPCペルソナ生成 (NPC Persona Generation)
*   **会話データ収集**: NPCごとに `DIAL/INFO` レコードから会話データを最大100件まで収集し、ペルソナ生成の入力とすること。
*   **トークン利用量の事前計算**: NPCごとに収集した会話データの想定トークン利用量を計算し、ペルソナ生成リクエスト前にコンテキスト長の評価を行えること。これにより、LLMのコンテキストウィンドウ超過を未然に防止する。
*   **LLMによるペルソナ生成**: 収集した会話データと既知のNPC属性（種族・性別・声の種類）をLLMに送信し、NPCの性格特性・話し方の癖・背景設定を含むペルソナテキストを生成すること。
*   **ペルソナの永続化と参照**: 生成されたペルソナをMod用語DBまたは専用ストアに保存し、Pass 2の翻訳時にコンテキストとして参照可能にすること。

---

## 4. 非機能要件

### 4.1 性能要件 (Performance)
*   **並列処理**: 独立した処理を並列化し、翻訳速度を向上させること。
*   **ローカル動作**: 外部のクラウドサービスに依存せず、ユーザーのローカル環境で完結して動作すること。

### 4.2 信頼性・可用性
*   **逐次保存**: 翻訳が完了するごとに結果を保存し、不慮の停止時におけるデータ損失を最小限に抑えること。
*   **エラー耐性**: 一部の翻訳が失敗しても、プロセス全体を停止せず、エラーを記録して処理を継続すること。

### 4.3 保守性・拡張性
*   **責務の分離**: データの入出力と変換ロジックを分離し、将来的な仕様変更や保守を容易にすること。
*   **スキーマ定義**: バージョン間の互換性を保つため、入出力データの構造を明確に定義すること。

---

## 5. データ仕様

### 5.1 入力ファイル形式
*   **Extraction Data**: xEdit等のツールから出力される、レコード情報を含む構造化データ。

### 5.2 出力ファイル形式
*   **Translation Data**: FormID、原文、訳文、メタデータを含む構造化データ。
    ```json
    [
      {
        "form_id": "0x001234|Skyrim.esm",
        "editor_id": "DialogTopic01",
        "type": "INFO",
        "original": "I took an arrow in the knee.",
        "string": "昔はお前のような冒険者だったのだが、膝に矢を受けてしまってな。"
      }
    ]
    ```

---

## 6. 制限事項と制約
*   **ハードウェア要件**: AIモデルを実用的な速度で動作させるための十分な計算資源が必要。
*   **AIモデル**: 文脈を理解し、十分な長のテキストを処理できるモデルが必要。
*   **依存ツール**: データの抽出には Skyrim Modディングツール (xEdit) が必要。

---
**著**: AI Architect (Antigravity)
**日付**: 2026-02-03
