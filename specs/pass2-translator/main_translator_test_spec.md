# 本文翻訳 テスト設計 (Pass2TranslatorSlice Test Spec)

本設計は `refactoring_strategy.md` セクション 6（テスト戦略）および セクション 7（構造化ログ基盤）に厳密に準拠し、個別関数の細粒度なユニットテストを作成せず、Vertical Slice の Contract に対する網羅的なパラメタライズドテスト（Table-Driven Test）を定義する。

## 1. テスト方針

1. **細粒度ユニットテストの排除**: 内部の機能分割モデル群(`PromptBuilder`, `TagProcessor`, `BookChunker`, `TranslationVerifier`, `ResultWriter`) の個別関数に対する細粒度なユニットテストは作成しない。
2. **網羅的パラメタライズドテスト**: すべてのテストを Table-Driven Test として実装し、インメモリ環境（`net/http/httptest` モックサーバーまたはモックインフラ、ファイルI/Oのモック/一時ディレクトリ）を用いて Contract 全体（`TranslationRequest` を受け取り、翻訳後 `TranslationResult` を返却または逐次保存するまでの一連のフロー）の振る舞いを検証する。
3. **構造化ログの強制検証**: テスト実行時においても、必ず `context.Context` （独自の TraceID を内包）を引き回す。

---

## 2. パラメタライズドテストケース (Table-Driven Tests)

各Contractに対する入力（初期状態 + アクション）と期待されるアウトプット（戻り値 + 変更後の状態）を表として定義し、ループ内で検証する。

### 2.1 Translator.Translate 統合テスト (単一翻訳)
1件の `TranslationRequest` に対し、タグ処理→プロンプト構築→LLM呼び出し→タグ復元→検証が行われるフローをテストする。

| ケースID | 目的                                     | 初期状態 (入力/設定/モック等)                                                                                             | アクション (関数呼出) | 期待される結果 (出力 / 状態)                                                                         |
| :------- | :--------------------------------------- | :------------------------------------------------------------------------------------------------------------------------ | :-------------------- | :--------------------------------------------------------------------------------------------------- |
| PTR-01   | 正常系: 汎用テキスト翻訳                 | モックLLMが「こんにちは」と返却する状態。<br>入力: 普通のテキストの `TranslationRequest`                                  | `Translate(ctx, req)` | エラーなし。<br>`Status="success"`, `TranslatedText="こんにちは"`。                                  |
| PTR-02   | 正常系: 強制翻訳指定 (ForcedTranslation) | 入力: `ForcedTranslation="鉄の剣"` が設定された `TranslationRequest`                                                      | `Translate(ctx, req)` | エラーなし。<br>LLMが**呼ばれず**、`Status="success"`, `TranslatedText="鉄の剣"`。                   |
| PTR-03   | 正常系: HTMLタグとプレースホルダー処理   | モックLLMがタグ復元用プレースホルダーを維持して返却する状態。<br>入力: `"<font>Hello</font>"` を含む `TranslationRequest` | `Translate(ctx, req)` | エラーなし。<br>タグが保護され、正しく復元された状態で返却されること。                               |
| PTR-04   | 正常系: 空・空白テキストのスキップ       | 入力: 全て空白、または空文字の `TranslationRequest`                                                                       | `Translate(ctx, req)` | エラーなし。<br>LLMが呼ばれず、`Status="skipped"`。                                                  |
| PTR-05   | 異常系: タグ不整合によるリトライと失敗   | モックLLMが常にプレースホルダーを破壊する（原文にないタグを捏造する等）状態。                                             | `Translate(ctx, req)` | 規定回数リトライされた後、`Status="failed"`となり、`ErrorMessage` にタグ不整合の旨が設定されること。 |
| PTR-06   | 異常系: コンテキストキャンセル           | `ctx.Cancel` が発行された状態のコンテキスト。                                                                             | `Translate(ctx, req)` | リトライされず即座にエラー/`failed`が返却されること。                                                |

### 2.2 BatchTranslator.TranslateBatch 統合テスト (並行翻訳・Resume・チャンク・保存)
複数リクエストの並行処理、Resume、BookChunker による書籍の長文分割、および ResultWriter によるファイル逐次保存のフローをテストする。

| ケースID | 目的                               | 初期状態 (入力/設定/モック等)                                                                                     | アクション (関数呼出) | 期待される結果 (出力 / 状態)                                                                                                                  |
| :------- | :--------------------------------- | :---------------------------------------------------------------------------------------------------------------- | :-------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------- |
| BPT-01   | 正常系: 複数リクエストの並行処理   | 一時ディレクトリを設定。<br>モックLLMが正常応答する状態。<br>入力: 3件の標準的な `TranslationRequest`             | `TranslateBatch(...)` | エラーなし。<br>3件とも `Status="success"` で結果が返り、一時ディレクトリのJSONに出力ファイルが作成されていること。                           |
| BPT-02   | 正常系: Resume（キャッシュ）の動作 | 一時ディレクトリに既存の翻訳済みJSON(1件)を事前配置。<br>入力: キャッシュ済みと同じIDの1件と新規2件の計3件        | `TranslateBatch(...)` | エラーなし。<br>キャッシュ済みのものはLLMが呼ばれず `Status="cached"`, 新規2件は `success` となること。                                       |
| BPT-03   | 正常系: 長文書籍のチャンク分割翻訳 | モックLLMが分割されたプロンプトに応答する状態。<br>入力: `RecordType="BOOK DESC"` の長文 `TranslationRequest` 1件 | `TranslateBatch(...)` | エラーなし。<br>内部で複数回LLMが呼ばれ、それらが結合された1つの `success` な出力として返ること。                                             |
| BPT-04   | 異常系: 一部失敗時の挙動           | モックLLMが特定のリクエストのみエラーを返す状態。<br>入力: 3件の `TranslationRequest`                             | `TranslateBatch(...)` | 処理全体はパニックせず完了し、結果リストに `success` と `failed` が混在して返還されること。<br>成功分のみが一時ディレクトリに保存されること。 |

---

## 3. 構造化ログとデバッグフロー (Log-based Debugging)

本スライスで不具合が発生した場合やテストが失敗した場合は、ステップ実行やユニットテストの追加による原因追及を行わず、実行生成物である構造化ログを用いたAIデバッグを徹底する。

### 3.1 テスト基盤でのログ準備
テストコードから Contract メソッドを呼び出す際は、サブテスト（Table-Drivenの各ケース）ごとに一意の TraceID を持つ `context.Context` を生成して引き回すこと。
各テスト実行時の `slog` の出力先はファイル（例: `logs/test_{timestamp}_Pass2Translator.jsonl`）に記録するようルーティングする。

### 3.2 AIデバッグプロンプトテンプレート
テスト失敗時やバグ発生時は、出力されたログと本仕様書を用いてAIにデバッグを依頼する。

```text
以下はスライス「Pass2TranslatorSlice」の実行ログファイル（logs/test_XXXXX_Pass2Translator.jsonl）の内容である。
仕様書（openspec/specs/Pass2TranslatorSlice/spec.md および 本テスト設計）の期待動作と比較し、乖離がある箇所を特定して修正コードを生成せよ。

--- 実行ログ ---
{ログファイル内容}

--- 期待される仕様 ---
{仕様書の該当セクション}
```
