# Schema-First AIDD 運用フローガイド

## 概要
本ドキュメントは、**「Schema-First AIDD Architecture v2」** に基づく、開発者の具体的な運用手順書です。
本アーキテクチャでは、**「ソースコードは人間が書くものではなく、仕様書からコンパイル（生成）されるアーティファクトである」** という前提で作業を進めます。

---

## 運用サイクル (The Loop)

作業は以下の **4つのフェーズ** を1サイクルとして回します。

### Phase 0: Sizing (実装視野の確保)
開発に着手する前に、機能を**「AIが一度に扱いきれるサイズ（Atomic Unit）」**に分割します。
*   **基準**: 1つのユースケース、1つのAPIエンドポイント、あるいは1つの画面遷移。
*   **原則**: 複雑な機能をそのままAIに投げない。「分割して統治（Divide and Conquer）」します。

---

### Phase 1: Definition (定義)
このフェーズが「コーディング」に相当します。人間は以下の2つの**Source of Truth**を編集します。

#### 1. IDL (Interface Definition Language) の記述
**「構造（Structure）」**を定義します。
*   **ファイル**: `.smithy` (推奨), `.proto` 等
*   **作業内容**:
    *   APIの入力・出力の型定義
    *   必須項目、文字列長、パターンなどのバリデーション制約（Trait）
    *   これにより、AIの解釈揺れ（ハルシネーション）を型レベルで封じ込めます。

#### 2. Implementation Plan (実装計画書) の作成
**「振る舞い（Behavior）」**と**「完了条件」**を定義します。
*   **ファイル**: `*.md` (Markdown)
*   **作業内容**:
    *   **Goal**: 何を実現するか。
    *   **Requirements**: ビジネスロジックの箇条書き。
    *   **Success Criteria (必須)**: 
        *   「何をもって完了とするか」を具体的かつ機械的に検証可能な形で記述します。
        *   例: 「APIが200 OKを返し、DBのusersテーブルにレコードが1件追加されていること」
    *   **※注意**: 具体的なコード（PythonやTSの実装）は書きません。

---

### Phase 2: Generation (生成)
定義が終わったら、AI（OpenSpec Agent）に生成を指示します。

1.  **CLI実行**: 生成コマンドを実行（例: `/opsx-ff` や `generate` コマンド）。
2.  **生成されるもの**:
    *   **ボイラープレート**: Router, Controller, DTO
    *   **データアクセス**: Repository, Entity
    *   **テストコード**: Success Criteriaに基づく自動テスト
    *   **インターフェース**: ビジネスロジックを実装するための空のクラス/関数

> **⚠️ 禁止事項**: 生成されたファイル（`src/generated/*` など）を直接修正してはいけません。修正が必要な場合は、必ず **Phase 1 (IDL/Plan)** に戻って再生成します。

---

### Phase 3: Implementation & Verification (実装と検証)
ここでの「実装」は、**「ドメインロジック」**のみに集中します。

1.  **ドメインロジックの実装**:
    *   AIが生成したインターフェース（Service Layerなど）の中身を実装します。
    *   複雑な計算、外部API連携、ステート管理など、人間が責任を持つべき「コアの振る舞い」を記述します。
    *   単純なCRUDであれば、AIがほぼ全て実装済みの場合もあります。
2.  **テスト実行**:
    *   自動生成されたテストを実行します。
    *   ❌ **Red (失敗)**:
        *   ロジックが間違っている → ドメインロジックを修正。
        *   仕様が間違っている/AIの生成コードがおかしい → **Phase 1**に戻り、PlanやIDLを修正して**再生成**。
    *   ✅ **Green (成功)**: 次のフェーズへ。

---

### Phase 4: Integration (統合)
1.  **アーカイブ**: 作業内容（Atomic Unit）を確定し、メインブランチや全体仕様書へ統合します。
2.  **次のサイクルへ**: 次の機能タスクへ移ります。

---

## トラブルシューティング

*   **Q: AIが意図しないコードを生成する**
    *   A: プロンプトで微調整するのではなく、**IDL**で型を厳格にするか、**Implementation Plan**の記述を具体的（Ambiguityを排除）にしてください。
*   **Q: 生成されたコードにバグがある**
    *   A: 生成コードを直さないでください。**Specを直して再生成（Re-roll）**してください。「コードを直す」運用に戻ると、AIDDのメリット（コンテキスト維持・再生成可能性）が崩壊します。
*   **Q: Success Criteriaが書けない**
    *   A: テストできない機能は実装すべきではありません。どうやって動作確認するかを先に考えることで、設計の品質が向上します。
